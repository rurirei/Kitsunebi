name: release

on:
  push:
    branches:
      - gobuild
  pull_request:
    branches:
      - gobuildx

jobs:

  build:
    name: Build
    runs-on: ubuntu-18.04
    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: Release Build
      run: |
        chmod +x ./gradlew
        ./gradlew assembleRelease

    - name: Signing Generator
      run: |
        keytool -genkey -v -keystore release.keystore -alias kitsunebi-android -storepass prelease-keystore -keypass prelease-key -keyalg RSA -keysize 2048 -validity 100000
        openssl base64 < release.keystore | tr -d '\n' | tee key.base64.txt
        echo key.base64.txt

    - name: Signing Android Build
      uses: r0adkll/sign-android-release@v1
      with:
        releaseDirectory: app/build/outputs/apk/release
        signingKeyBase64: yu7acOeOjYV4lqVolkYgNA==
        alias: kitsunebi-android
        keyStorePassword: prelease-keystore
        keyPassword: prelease-key

    - name: Get Release Tag
      run: |
        echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

    - name: Upload tha APK to the Release on Github
      uses: meeDamian/github-release@2.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ env.RELEASE_VERSION }}
        files: ${{ env.SIGNED_RELEASE_FILE }}
        allow_override: false
        gzip: false
